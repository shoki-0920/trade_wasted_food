<% breadcrumb :fishing_spots_map %>

<h1 class="text-3xl font-bold mb-4 text-center text-blue-600">é‡£ã‚Šå ´ãƒãƒƒãƒ—</h1>

<p class="text-center text-lg text-gray-600 mb-6">
  ãƒãƒƒãƒ—ä¸Šã®é‡£ã‚Šå ´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãã®é‡£ã‚Šå ´ã®æŠ•ç¨¿ã‚’ç¢ºèªã—ã‚ˆã†ï¼
</p>

<div id="map" class="w-full h-[500px] rounded-xl shadow-lg"></div>

<script>
  // Google Maps API ã®é‡è¤‡èª­ã¿è¾¼ã¿ã‚’é˜²ã
  if (!window.googleMapsLoaded) {
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ fishingSpots ã‚’è¨­å®š
    window.fishingSpotsData = <%= raw(@fishing_spots.to_json(only: [:id, :name, :latitude, :longitude])) %>;
    
    // é‡£ã‚Šå ´ãƒãƒ¼ã‚«ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createFishingSpotIcon() {
      return {
        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
            <circle cx="20" cy="20" r="18" fill="#ff6b6b" stroke="white" stroke-width="2"/>
            <text x="20" y="26" text-anchor="middle" font-size="20" fill="white">ğŸ£</text>
          </svg>
        `),
        scaledSize: new google.maps.Size(40, 40),
        anchor: new google.maps.Point(20, 20)
      };
    }

    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆã™ã‚‹é–¢æ•°
    function createCurrentLocationIcon() {
      return {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 10,
        fillColor: '#4285F4',
        fillOpacity: 1,
        strokeColor: 'white',
        strokeWeight: 3
      };
    }

    // ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ–é–¢æ•°
    window.initMap = function() {
      console.log("âœ… initMap é–‹å§‹");
      
      // é‡è¤‡åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
      if (window.mapInstance) {
        console.log("ğŸ”„ ãƒãƒƒãƒ—ã¯æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™");
        return;
      }

      const mapElement = document.getElementById("map");
      if (!mapElement) {
        console.error("âŒ #map è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
      }

      try {
        // ãƒãƒƒãƒ—ã‚’ä½œæˆ
        const map = new google.maps.Map(mapElement, {
          center: { lat: 34.6937, lng: 135.5023 },
          zoom: 11,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä¿å­˜
        window.mapInstance = map;

        console.log("âœ… ãƒãƒƒãƒ—ä½œæˆå®Œäº†");

        // é‡£ã‚Šå ´ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ 
        if (window.fishingSpotsData && window.fishingSpotsData.length > 0) {
          window.fishingSpotsData.forEach(spot => {
            const marker = new google.maps.Marker({
              position: { 
                lat: parseFloat(spot.latitude), 
                lng: parseFloat(spot.longitude) 
              },
              map: map,
              title: spot.name,
              icon: createFishingSpotIcon()
            });

            marker.addListener("click", () => {
              window.location.href = `/fishing_spots/${spot.id}/posts`;
            });
          });
          console.log(`âœ… ${window.fishingSpotsData.length}å€‹ã®é‡£ã‚Šå ´ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ `);
        }

        // ç¾åœ¨åœ°è¡¨ç¤ºé–¢æ•°
        const showCurrentLocation = (lat, lng) => {
          const currentPos = { lat, lng };
          console.log("ğŸ–¥ï¸ ç¾åœ¨åœ°ã‚’è¡¨ç¤º:", currentPos);

          // ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’ç¾åœ¨åœ°ã«è¨­å®š
          map.setCenter(currentPos);
          map.setZoom(13);

          // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
          const currentLocationMarker = new google.maps.Marker({
            position: currentPos,
            map: map,
            title: "ç¾åœ¨åœ°",
            icon: createCurrentLocationIcon()
          });

          // ç¾åœ¨åœ°ã®å††
          const currentLocationCircle = new google.maps.Circle({
            strokeColor: '#4285F4',
            strokeOpacity: 0.4,
            strokeWeight: 2,
            fillColor: '#4285F4',
            fillOpacity: 0.15,
            map: map,
            center: currentPos,
            radius: 200
          });

          console.log("âœ… ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã¨å††ã‚’è¿½åŠ ");
        };

        // ä½ç½®æƒ…å ±ã®å–å¾—
        if ("geolocation" in navigator) {
          console.log("âœ… ä½ç½®æƒ…å ±å–å¾—ã‚’é–‹å§‹");
          
          const options = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 300000 // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
          };

          navigator.geolocation.getCurrentPosition(
            (position) => {
              console.log("âœ… ç¾åœ¨åœ°å–å¾—æˆåŠŸ:", position.coords);
              showCurrentLocation(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
              console.warn("âš ï¸ ç¾åœ¨åœ°å–å¾—å¤±æ•—:", error.message);
              console.log("ğŸ“ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆå¤§é˜ªï¼‰ã‚’è¡¨ç¤º");
              // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã®ãƒãƒ¼ã‚«ãƒ¼ã¯è¡¨ç¤ºã—ãªã„
            },
            options
          );
        } else {
          console.warn("âš ï¸ geolocation éå¯¾å¿œ");
        }

        console.log("âœ… ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†");

      } catch (error) {
        console.error("âŒ ãƒãƒƒãƒ—åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        window.mapInstance = null;
      }
    };

    // Google Maps API èª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°
    window.googleMapsLoaded = true;
  }

  // Turbo ã§ãƒšãƒ¼ã‚¸ãŒå¤‰ã‚ã£ãŸæ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  document.addEventListener('turbo:before-visit', function() {
    if (window.mapInstance) {
      // ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªã‚¢
      window.mapInstance = null;
    }
  });
</script>

<!-- Google Maps API ã‚’æ¡ä»¶ä»˜ãã§èª­ã¿è¾¼ã¿ -->
<% unless Rails.env.test? %>
  <script>
    // Google Maps API ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã®ã¿èª­ã¿è¾¼ã‚€
    if (typeof google === 'undefined' || !google.maps) {
      console.log("ğŸ“¡ Google Maps API ã‚’èª­ã¿è¾¼ã¿ä¸­...");
      const script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap';
      script.async = true;
      script.defer = true;
      
      script.onload = function() {
        console.log("âœ… Google Maps API èª­ã¿è¾¼ã¿å®Œäº†");
      };
      
      script.onerror = function() {
        console.error("âŒ Google Maps API èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼");
      };
      
      document.head.appendChild(script);
    } else {
      console.log("âœ… Google Maps API ã¯æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿");
      // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯ç›´æ¥åˆæœŸåŒ–
      if (typeof window.initMap === 'function') {
        window.initMap();
      }
    }
  </script>
<% end %>